<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data noupdate="0">

        <!-- REUSABLE EMPLOYEE TABLE -->
        <template id="19_lunch_management.lunch_report_employee_table">
            <table class="table table-bordered table-hover table-sm" style="font-size: 94%;">
                <thead style="background-color: #3498db; color: white;">
                    <tr>
                        <th class="text-center">Date</th>
                        <th class="text-center">Day</th>
                        <th class="text-center">Lunch Type</th>
                        <th class="text-right">Cost</th>
                    </tr>
                </thead>
                <tbody>
                    <t t-set="subtotal" t-value="0.0" />
                    <t t-foreach="records" t-as="r">
                        <tr>
                            <td class="text-center">
                                <t t-esc="r.date.strftime('%d/%m/%Y')" />
                            </td>
                            <td class="text-center">
                                <t t-esc="r.day" />
                            </td>
                            <td>
                                <t t-esc="r.lunch_type.lunch_type" />
                            </td>
                            <td class="text-right">
                                <t t-if="r.state == 'confirmed'">
                                    <t t-esc="r.cost"
                                        t-options='{"widget":"monetary","display_currency":env.company.currency_id}' />
                                </t>
                                <t t-else="">
                                    <span style="color:#95a5a6;">â€”</span>
                                </t>
                            </td>
                        </tr>
                        <!-- Only add cost if confirmed -->
                        <t t-set="subtotal"
                            t-value="subtotal + (r.cost if r.state == 'confirmed' else 0)" />
                    </t>
                    <tr style="background:#ecf0f1; font-weight:bold;">
                        <td colspan="3" class="text-right"> Subtotal (<t t-esc="len(records)" />
                            days): </td>
                        <td class="text-right">
                            <t t-esc="subtotal"
                                t-options='{"widget":"monetary","display_currency":env.company.currency_id}' />
                        </td>
                    </tr>
                </tbody>
            </table>
        </template>

        <!-- MAIN REPORT TEMPLATE -->
        <template id="report_lunch_document" name="Lunch Report Document">
            <t t-call="web.html_container">
                <t t-call="web.external_layout">
                    <div class="page">

                        <!-- Context data -->
                        <t t-set="data" t-value="env.context.get('report_data', {})" />
                        <t t-set="selected_emp_id" t-value="data.get('employee_id')" />

                        <!-- Header -->
                        <div class="text-center mb-4">
                            <h2 style="color:#2c3e50; margin-bottom:8px;">
                                <t t-if="not selected_emp_id">
                                    All Employees Lunch Report
                                </t>
                                <t t-else=""> Lunch Report - <t t-esc="docs[0].employee_id.name" />
                                </t>
                            </h2>
                            <h4 class="text-muted">
                                <t t-esc="data.get('date_from')" /> to <t
                                    t-esc="data.get('date_to')" />
                            </h4>
                        </div>

                        <!-- SINGLE EMPLOYEE VIEW -->
                        <t t-if="selected_emp_id">
                            <t t-set="records" t-value="docs" />
                            <t t-call="19_lunch_management.lunch_report_employee_table" />
                        </t>

                        <!-- ALL EMPLOYEES (GROUPED) -->
                        <t t-if="not selected_emp_id">
                            <t t-set="employees" t-value="docs.mapped('employee_id').sorted('name')" />
                            <t t-set="grand_total" t-value="0.0" />

                            <t t-foreach="employees" t-as="emp">
                                <t t-set="emp_records"
                                    t-value="docs.filtered(lambda x: x.employee_id == emp)" />
                                <t t-set="emp_total" t-value="sum(emp_records.mapped('cost'))" />
                                <t t-set="grand_total" t-value="grand_total + emp_total" />

                                <div class="mb-5 mt-4">
                                    <h3
                                        style="background:#34495e; color:white; padding:12px 16px; border-radius:8px; margin:0;">
                                        <span t-esc="emp.name" />
                                        <span class="float-right font-weight-bold">
                                            <t t-esc="emp_total"
                                                t-options='{"widget":"monetary","display_currency":env.company.currency_id}' />
                                        </span>
                                    </h3>
                                    <t t-set="records" t-value="emp_records" />
                                    <t t-call="19_lunch_management.lunch_report_employee_table" />
                                </div>
                            </t>

                            <!-- GRAND TOTAL -->
                            <div class="text-center mt-5">
                                <h2
                                    style="background:#27ae60; color:white; padding:18px 80px; border-radius:12px; display:inline-block; font-size:1.5em;">
                                    GRAND TOTAL: <strong t-esc="grand_total"
                                        t-options='{"widget":"monetary","display_currency":env.company.currency_id}' />
                                </h2>
                            </div>
                        </t>

                        <!-- Footer -->
                        <div class="text-center mt-5" style="color:#7f8c8d; font-size:11px;">
                            Generated on <t
                                t-esc="context_timestamp(datetime.datetime.now()).strftime('%d %B %Y at %I:%M %p')" />
                        <br />
                        <t
                                t-esc="env.company.name" />
                        </div>

                    </div>
                </t>
            </t>
        </template>

        <!-- PDF Report Action -->
        <record id="action_report_lunch" model="ir.actions.report">
            <field name="name">Lunch Report (PDF)</field>
            <field name="model">lunch.record</field>
            <field name="report_type">qweb-pdf</field>
            <field name="report_name">19_lunch_management.report_lunch_document</field>
            <field name="report_file">19_lunch_management.report_lunch_document</field>
            <field name="binding_model_id" ref="model_lunch_record" />
            <field name="binding_type">report</field>
        </record>

    </data>
</odoo>